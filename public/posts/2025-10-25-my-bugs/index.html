<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>My Bugs Graveyard | Random notes to myself</title>
<meta name=keywords content><meta name=description content="1. HTTP call to 3rd party API responds with error from our local database
Diagnosis: I see a weird error in the logs, it looks like something like this:
error happened GET https://example.com, <service database error>
where you can see endpoint url and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!"><meta name=author content><link rel=canonical href=https://localhost:1313/posts/2025-10-25-my-bugs/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=https://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=https://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://localhost:1313/posts/2025-10-25-my-bugs/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="My Bugs Graveyard"><meta property="og:description" content="1. HTTP call to 3rd party API responds with error from our local database
Diagnosis: I see a weird error in the logs, it looks like something like this:
error happened GET https://example.com, <service database error>
where you can see endpoint url and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!"><meta property="og:type" content="article"><meta property="og:url" content="https://localhost:1313/posts/2025-10-25-my-bugs/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-10-25T00:00:00+00:00"><meta property="article:modified_time" content="2025-10-25T00:00:00+00:00"><meta property="og:site_name" content="Random notes to myself"><meta name=twitter:card content="summary"><meta name=twitter:title content="My Bugs Graveyard"><meta name=twitter:description content="1. HTTP call to 3rd party API responds with error from our local database
Diagnosis: I see a weird error in the logs, it looks like something like this:
error happened GET https://example.com, <service database error>
where you can see endpoint url and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"My Bugs Graveyard","item":"https://localhost:1313/posts/2025-10-25-my-bugs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"My Bugs Graveyard","name":"My Bugs Graveyard","description":"1. HTTP call to 3rd party API responds with error from our local database Diagnosis: I see a weird error in the logs, it looks like something like this:\nerror happened GET https://example.com, \u0026lt;service database error\u0026gt; where you can see endpoint url and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!\n","keywords":[],"articleBody":"1. HTTP call to 3rd party API responds with error from our local database Diagnosis: I see a weird error in the logs, it looks like something like this:\nerror happened GET https://example.com, where you can see endpoint url and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!\nBelow you will find a completely reproducible example:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package main import ( \"context\" \"fmt\" \"net/http\" \"net/http/httptest\" \"time\" \"golang.org/x/sync/errgroup\" ) func main() { server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { time.Sleep(2 * time.Second) w.WriteHeader(http.StatusOK) })) defer server.Close() g, ctx := errgroup.WithContext(context.Background()) g.Go(func() error { time.Sleep(500 * time.Millisecond) return fmt.Errorf(\"mongodb_error_poison\") }) g.Go(func() error { req, _ := http.NewRequestWithContext(ctx, http.MethodGet, server.URL, nil) _, err := http.DefaultClient.Do(req) if err != nil { fmt.Printf(\"client.Do error: %v\\n\", err) } return err }) g.Wait() } and the output will be:\nclient.Do error: Get \"http://127.0.0.1:41339\": mongodb_error_poison how come? what is going on? any guesses? turns out the following is happening: errgroup.Wait will cancel the context as soon as any of gorouitines return an error. internally errgroup will use a special context.WithCancelCause context which returns context itself and cancel that accepts an error as a cause.\nnow as soon as context is cancelled http.DefaultClient.Do(req) with request that has our context immediately return error. but method Do has this comment: // Any returned error will be of type [*url.Error]. and the url.Error looks like this\n// Error reports an error and the operation and URL that caused it. type Error struct { Op string URL string Err error } long story short that cause from context, which is an error, will be assigned to Err field in url.Error and this is how database error bubbled up was returned from http call.\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 package main import ( \"context\" \"fmt\" \"net/http\" \"net/http/httptest\" \"time\" \"golang.org/x/sync/errgroup\" ) func main() { // 1. Setup a slow server that sleeps longer than the \"poison\" delay server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { //fmt.Println(\"[Server] Received request, sleeping...\") time.Sleep(2 * time.Second) // Sleep longer than the error trigger w.WriteHeader(http.StatusOK) w.Write([]byte(\"OK\")) // fmt.Println(\"[Server] Request completed (should not be seen if context cancels client)\") })) defer server.Close() ctx := context.Background() g, ctx := errgroup.WithContext(ctx) // 2. Routine 1: The \"Poison\" - fails quickly g.Go(func() error { fmt.Println(\"[Poison] Waiting to trigger error...\") time.Sleep(500 * time.Millisecond) fmt.Println(\"[Poison] TRIGGERING ERROR: an error poisoned the workflow!\") return fmt.Errorf(\"mongodb_error_poison\") }) // 3. Routine 2: The \"Victim\" - tries to fetch data with retries g.Go(func() error { return fetchDataBuggy(ctx, server.URL) }) // Wait for completion if err := g.Wait(); err != nil { fmt.Printf(\"\\n[Main] Workflow finished with error: %v\\n\", err) } else { fmt.Println(\"\\n[Main] Workflow finished successfully\") } } // fetchDataBuggy reproduces the issue where we retry on context cancellation // because we don't check ctx.Err() explicitly when client.Do returns an error. func fetchDataBuggy(ctx context.Context, url string) error { client := \u0026http.Client{ Timeout: 10 * time.Second, // Long enough timeout } maxRetries := 5 for i := 0; i \u003c maxRetries; i++ { fmt.Printf(\"[Client] Attempt %d starting...\\n\", i+1) req, _ := http.NewRequestWithContext(ctx, http.MethodGet, url, nil) // When the context is cancelled by the [Poison] routine, // client.Do returns an error. _, err := client.Do(req) if err != nil { // --- THE BUG IS HERE --- // We treat this error as a network glitch and retry. // But the error is actually due to context cancellation! fmt.Printf(\"[Client] Attempt %d failed. Error type: %T. Error: %v\\n\", i+1, err, err) // To prove the point, let's check if context is actually cancelled if ctx.Err() != nil { fmt.Printf(\"[Client] (Debug) Context IS cancelled: %v. But we are retrying anyway!\\n\", ctx.Err()) } // Simple backoff retryWait := 500 * time.Millisecond fmt.Printf(\"[Client] Sleeping %v before retry...\\n\\n\", retryWait) // We sleep. If context is cancelled, time.Sleep returns immediately? // No, time.Sleep takes a Duration, it doesn't know about context. // So we actually pause execution here. time.Sleep(retryWait) continue } fmt.Println(\"[Client] Success!\") return nil } return fmt.Errorf(\"max retries exceeded\") } An output will look like so:\nslash3b@Xtal /t/tmp.NRGeUVBS7A\u003e go run main.go [Client] Attempt 1 starting... [Poison] Waiting to trigger error... [Poison] TRIGGERING ERROR: an error poisoned the workflow! [Client] Attempt 1 failed. Error type: *url.Error. Error: Get \"http://127.0.0.1:45689\": mongodb_error_poison [Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway! [Client] Sleeping 500ms before retry... [Client] Attempt 2 starting... [Client] Attempt 2 failed. Error type: *url.Error. Error: Get \"http://127.0.0.1:45689\": mongodb_error_poison [Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway! [Client] Sleeping 500ms before retry... [Client] Attempt 3 starting... [Client] Attempt 3 failed. Error type: *url.Error. Error: Get \"http://127.0.0.1:45689\": mongodb_error_poison [Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway! [Client] Sleeping 500ms before retry... [Client] Attempt 4 starting... [Client] Attempt 4 failed. Error type: *url.Error. Error: Get \"http://127.0.0.1:45689\": mongodb_error_poison [Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway! [Client] Sleeping 500ms before retry... [Client] Attempt 5 starting... [Client] Attempt 5 failed. Error type: *url.Error. Error: Get \"http://127.0.0.1:45689\": mongodb_error_poison [Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway! [Client] Sleeping 500ms before retry... [Main] Workflow finished with error: mongodb_error_poison ","wordCount":"991","inLanguage":"en","datePublished":"2025-10-25T00:00:00Z","dateModified":"2025-10-25T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://localhost:1313/posts/2025-10-25-my-bugs/"},"publisher":{"@type":"Organization","name":"Random notes to myself","logo":{"@type":"ImageObject","url":"https://localhost:1313/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=https://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://localhost:1313/archives/ title=archives><span>archives</span></a></li><li><a href=https://localhost:1313/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">My Bugs Graveyard</h1><div class=post-meta><span title='2025-10-25 00:00:00 +0000 UTC'>October 25, 2025</span>&nbsp;·&nbsp;5 min&nbsp;·&nbsp;991 words&nbsp;|&nbsp;<a href=https://github.com/slash3b/slash3b.github.io/content/posts/2025-10-25-my-bugs.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><h4 id=1-http-call-to-3rd-party-api-responds-with-error-from-our-local-database>1. HTTP call to 3rd party API responds with error from our local database<a hidden class=anchor aria-hidden=true href=#1-http-call-to-3rd-party-api-responds-with-error-from-our-local-database>#</a></h4><p>Diagnosis: I see a weird error in the logs, it looks like something like this:</p><pre tabindex=0><code>error happened GET https://example.com, &lt;service database error&gt;
</code></pre><p>where you can see endpoint url and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!</p><p>Below you will find a completely reproducible example:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;net/http/httptest&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>func</span> <span style=color:#666;font-weight:700;font-style:italic>main</span>() {
</span></span><span style=display:flex><span>	server := httptest.<span style=color:#666;font-weight:700;font-style:italic>NewServer</span>(http.<span style=color:#666;font-weight:700;font-style:italic>HandlerFunc</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(2 * time.Second)
</span></span><span style=display:flex><span>		w.<span style=color:#666;font-weight:700;font-style:italic>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>	}))
</span></span><span style=display:flex><span>	<span style=font-weight:700;text-decoration:underline>defer</span> server.<span style=color:#666;font-weight:700;font-style:italic>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g, ctx := errgroup.<span style=color:#666;font-weight:700;font-style:italic>WithContext</span>(context.<span style=color:#666;font-weight:700;font-style:italic>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g.<span style=color:#666;font-weight:700;font-style:italic>Go</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>() <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>		time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(500 * time.Millisecond)
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> fmt.<span style=color:#666;font-weight:700;font-style:italic>Errorf</span>(<span style=color:#666;font-style:italic>&#34;mongodb_error_poison&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g.<span style=color:#666;font-weight:700;font-style:italic>Go</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>() <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>		req, _ := http.<span style=color:#666;font-weight:700;font-style:italic>NewRequestWithContext</span>(ctx, http.MethodGet, server.URL, <span style=font-weight:700;text-decoration:underline>nil</span>)
</span></span><span style=display:flex><span>		_, err := http.DefaultClient.<span style=color:#666;font-weight:700;font-style:italic>Do</span>(req)
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>if</span> err != <span style=font-weight:700;text-decoration:underline>nil</span> {
</span></span><span style=display:flex><span>			fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;client.Do error: %v\n&#34;</span>, err)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> err
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g.<span style=color:#666;font-weight:700;font-style:italic>Wait</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>and the output will be:</p><pre tabindex=0><code>client.Do error: Get &#34;http://127.0.0.1:41339&#34;: mongodb_error_poison
</code></pre><p>how come? what is going on? any guesses?
turns out the following is happening:
errgroup.Wait will cancel the context as soon as any of gorouitines return an error.
internally errgroup will use a special <code>context.WithCancelCause</code> context which returns context itself
and cancel that <strong>accepts an error</strong> as a cause.</p><p>now as soon as context is cancelled <code>http.DefaultClient.Do(req)</code> with request that has our context immediately return error.
but method <code>Do</code> has this comment:
<code>// Any returned error will be of type [*url.Error].</code>
and the <code>url.Error</code> looks like this</p><pre tabindex=0><code>// Error reports an error and the operation and URL that caused it.
type Error struct {
        Op  string
        URL string
        Err error
}
</code></pre><p>long story short that cause from context, which is an error, will be assigned to <code>Err</code> field in <code>url.Error</code>
and this is how database error bubbled up was returned from http call.</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">38
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">39
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">40
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">41
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">42
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">43
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">44
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">45
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">46
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">47
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">48
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">49
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">50
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">51
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">52
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">53
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">54
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">55
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">56
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">57
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">58
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">59
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">60
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">61
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">62
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">63
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">64
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">65
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">66
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">67
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">68
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">69
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">70
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">71
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">72
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">73
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">74
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">75
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">76
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">77
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">78
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">79
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">80
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">81
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">82
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">83
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">84
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">85
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">86
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">87
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">88
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">89
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">90
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">91
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">92
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">93
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">94
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">95
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">96
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;net/http/httptest&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>func</span> <span style=color:#666;font-weight:700;font-style:italic>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// 1. Setup a slow server that sleeps longer than the &#34;poison&#34; delay
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>	server := httptest.<span style=color:#666;font-weight:700;font-style:italic>NewServer</span>(http.<span style=color:#666;font-weight:700;font-style:italic>HandlerFunc</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>//fmt.Println(&#34;[Server] Received request, sleeping...&#34;)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>		time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(2 * time.Second) <span style=color:#888;font-style:italic>// Sleep longer than the error trigger
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>		w.<span style=color:#666;font-weight:700;font-style:italic>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>		w.<span style=color:#666;font-weight:700;font-style:italic>Write</span>([]<span style=font-weight:700;font-style:italic>byte</span>(<span style=color:#666;font-style:italic>&#34;OK&#34;</span>))
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// fmt.Println(&#34;[Server] Request completed (should not be seen if context cancels client)&#34;)
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>	}))
</span></span><span style=display:flex><span>	<span style=font-weight:700;text-decoration:underline>defer</span> server.<span style=color:#666;font-weight:700;font-style:italic>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	ctx := context.<span style=color:#666;font-weight:700;font-style:italic>Background</span>()
</span></span><span style=display:flex><span>	g, ctx := errgroup.<span style=color:#666;font-weight:700;font-style:italic>WithContext</span>(ctx)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// 2. Routine 1: The &#34;Poison&#34; - fails quickly
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>	g.<span style=color:#666;font-weight:700;font-style:italic>Go</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>() <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>		fmt.<span style=color:#666;font-weight:700;font-style:italic>Println</span>(<span style=color:#666;font-style:italic>&#34;[Poison] Waiting to trigger error...&#34;</span>)
</span></span><span style=display:flex><span>		time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(500 * time.Millisecond)
</span></span><span style=display:flex><span>		fmt.<span style=color:#666;font-weight:700;font-style:italic>Println</span>(<span style=color:#666;font-style:italic>&#34;[Poison] TRIGGERING ERROR: an error poisoned the workflow!&#34;</span>)
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> fmt.<span style=color:#666;font-weight:700;font-style:italic>Errorf</span>(<span style=color:#666;font-style:italic>&#34;mongodb_error_poison&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// 3. Routine 2: The &#34;Victim&#34; - tries to fetch data with retries
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>	g.<span style=color:#666;font-weight:700;font-style:italic>Go</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>() <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> <span style=color:#666;font-weight:700;font-style:italic>fetchDataBuggy</span>(ctx, server.URL)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#888;font-style:italic>// Wait for completion
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>	<span style=font-weight:700;text-decoration:underline>if</span> err := g.<span style=color:#666;font-weight:700;font-style:italic>Wait</span>(); err != <span style=font-weight:700;text-decoration:underline>nil</span> {
</span></span><span style=display:flex><span>		fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;\n[Main] Workflow finished with error: %v\n&#34;</span>, err)
</span></span><span style=display:flex><span>	} <span style=font-weight:700;text-decoration:underline>else</span> {
</span></span><span style=display:flex><span>		fmt.<span style=color:#666;font-weight:700;font-style:italic>Println</span>(<span style=color:#666;font-style:italic>&#34;\n[Main] Workflow finished successfully&#34;</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#888;font-style:italic>// fetchDataBuggy reproduces the issue where we retry on context cancellation
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic>// because we don&#39;t check ctx.Err() explicitly when client.Do returns an error.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span><span style=font-weight:700;font-style:italic;text-decoration:underline>func</span> <span style=color:#666;font-weight:700;font-style:italic>fetchDataBuggy</span>(ctx context.Context, url <span style=font-weight:700;text-decoration:underline>string</span>) <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>	client := &amp;http.Client{
</span></span><span style=display:flex><span>		Timeout: 10 * time.Second, <span style=color:#888;font-style:italic>// Long enough timeout
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	maxRetries := 5
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700;text-decoration:underline>for</span> i := 0; i &lt; maxRetries; i++ {
</span></span><span style=display:flex><span>		fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;[Client] Attempt %d starting...\n&#34;</span>, i+1)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		req, _ := http.<span style=color:#666;font-weight:700;font-style:italic>NewRequestWithContext</span>(ctx, http.MethodGet, url, <span style=font-weight:700;text-decoration:underline>nil</span>)
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=color:#888;font-style:italic>// When the context is cancelled by the [Poison] routine, 
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>		<span style=color:#888;font-style:italic>// client.Do returns an error.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>		_, err := client.<span style=color:#666;font-weight:700;font-style:italic>Do</span>(req)
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>if</span> err != <span style=font-weight:700;text-decoration:underline>nil</span> {
</span></span><span style=display:flex><span>			<span style=color:#888;font-style:italic>// --- THE BUG IS HERE ---
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			<span style=color:#888;font-style:italic>// We treat this error as a network glitch and retry.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			<span style=color:#888;font-style:italic>// But the error is actually due to context cancellation!
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			
</span></span><span style=display:flex><span>			fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;[Client] Attempt %d failed. Error type: %T. Error: %v\n&#34;</span>, i+1, err, err)
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=color:#888;font-style:italic>// To prove the point, let&#39;s check if context is actually cancelled
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			<span style=font-weight:700;text-decoration:underline>if</span> ctx.<span style=color:#666;font-weight:700;font-style:italic>Err</span>() != <span style=font-weight:700;text-decoration:underline>nil</span> {
</span></span><span style=display:flex><span>				fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;[Client] (Debug) Context IS cancelled: %v. But we are retrying anyway!\n&#34;</span>, ctx.<span style=color:#666;font-weight:700;font-style:italic>Err</span>())
</span></span><span style=display:flex><span>			}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>			<span style=color:#888;font-style:italic>// Simple backoff
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			retryWait := 500 * time.Millisecond
</span></span><span style=display:flex><span>			fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;[Client] Sleeping %v before retry...\n\n&#34;</span>, retryWait)
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=color:#888;font-style:italic>// We sleep. If context is cancelled, time.Sleep returns immediately? 
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			<span style=color:#888;font-style:italic>// No, time.Sleep takes a Duration, it doesn&#39;t know about context.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			<span style=color:#888;font-style:italic>// So we actually pause execution here.
</span></span></span><span style=display:flex><span><span style=color:#888;font-style:italic></span>			time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(retryWait)
</span></span><span style=display:flex><span>			
</span></span><span style=display:flex><span>			<span style=font-weight:700;text-decoration:underline>continue</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		
</span></span><span style=display:flex><span>		fmt.<span style=color:#666;font-weight:700;font-style:italic>Println</span>(<span style=color:#666;font-style:italic>&#34;[Client] Success!&#34;</span>)
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> <span style=font-weight:700;text-decoration:underline>nil</span>
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=font-weight:700;text-decoration:underline>return</span> fmt.<span style=color:#666;font-weight:700;font-style:italic>Errorf</span>(<span style=color:#666;font-style:italic>&#34;max retries exceeded&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>An output will look like so:</p><pre tabindex=0><code>slash3b@Xtal /t/tmp.NRGeUVBS7A&gt; go run main.go
[Client] Attempt 1 starting...
[Poison] Waiting to trigger error...
[Poison] TRIGGERING ERROR: an error poisoned the workflow!
[Client] Attempt 1 failed. Error type: *url.Error. Error: Get &#34;http://127.0.0.1:45689&#34;: mongodb_error_poison
[Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway!
[Client] Sleeping 500ms before retry...

[Client] Attempt 2 starting...
[Client] Attempt 2 failed. Error type: *url.Error. Error: Get &#34;http://127.0.0.1:45689&#34;: mongodb_error_poison
[Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway!
[Client] Sleeping 500ms before retry...

[Client] Attempt 3 starting...
[Client] Attempt 3 failed. Error type: *url.Error. Error: Get &#34;http://127.0.0.1:45689&#34;: mongodb_error_poison
[Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway!
[Client] Sleeping 500ms before retry...

[Client] Attempt 4 starting...
[Client] Attempt 4 failed. Error type: *url.Error. Error: Get &#34;http://127.0.0.1:45689&#34;: mongodb_error_poison
[Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway!
[Client] Sleeping 500ms before retry...

[Client] Attempt 5 starting...
[Client] Attempt 5 failed. Error type: *url.Error. Error: Get &#34;http://127.0.0.1:45689&#34;: mongodb_error_poison
[Client] (Debug) Context IS cancelled: context canceled. But we are retrying anyway!
[Client] Sleeping 500ms before retry...


[Main] Workflow finished with error: mongodb_error_poison
</code></pre></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://localhost:1313/>Random notes to myself</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>