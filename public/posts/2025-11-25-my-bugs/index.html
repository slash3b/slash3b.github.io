<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>My Bugs Graveyard | Random notes to myself</title>
<meta name=keywords content><meta name=description content="This is a collection of subtle bugs I&rsquo;ve encountered in Go that took time to understand.
Each entry documents the issue, a reproducible example, and the root cause"><meta name=author content><link rel=canonical href=https://localhost:1313/posts/2025-11-25-my-bugs/><link crossorigin=anonymous href=/assets/css/stylesheet.b609c58d5c11bb90b1a54e04005d74ad1ddf22165eb79f5533967e57df9c3b50.css integrity="sha256-tgnFjVwRu5CxpU4EAF10rR3fIhZet59VM5Z+V9+cO1A=" rel="preload stylesheet" as=style><link rel=icon href=https://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=https://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=https://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=https://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://localhost:1313/posts/2025-11-25-my-bugs/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="My Bugs Graveyard"><meta property="og:description" content="This is a collection of subtle bugs I&rsquo;ve encountered in Go that took time to understand.
Each entry documents the issue, a reproducible example, and the root cause"><meta property="og:type" content="article"><meta property="og:url" content="https://localhost:1313/posts/2025-11-25-my-bugs/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2025-11-25T00:00:00+00:00"><meta property="article:modified_time" content="2025-11-25T00:00:00+00:00"><meta property="og:site_name" content="Random notes to myself"><meta name=twitter:card content="summary"><meta name=twitter:title content="My Bugs Graveyard"><meta name=twitter:description content="This is a collection of subtle bugs I&rsquo;ve encountered in Go that took time to understand.
Each entry documents the issue, a reproducible example, and the root cause"><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"My Bugs Graveyard","item":"https://localhost:1313/posts/2025-11-25-my-bugs/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"My Bugs Graveyard","name":"My Bugs Graveyard","description":"This is a collection of subtle bugs I\u0026rsquo;ve encountered in Go that took time to understand. Each entry documents the issue, a reproducible example, and the root cause\n","keywords":[],"articleBody":"This is a collection of subtle bugs I’ve encountered in Go that took time to understand. Each entry documents the issue, a reproducible example, and the root cause\n1. HTTP call to 3rd party API responds with error from our local database Diagnosis: I see a weird error in the logs, it looks like this:\nerror happened GET https://example.com, where you can see endpoint URL and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!\nBelow you will find a completely reproducible example:\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 package main import ( \"context\" \"fmt\" \"net/http\" \"net/http/httptest\" \"time\" \"golang.org/x/sync/errgroup\" ) func main() { server := httptest.NewServer(http.HandlerFunc(func(w http.ResponseWriter, r *http.Request) { time.Sleep(2 * time.Second) w.WriteHeader(http.StatusOK) })) defer server.Close() g, ctx := errgroup.WithContext(context.Background()) g.Go(func() error { time.Sleep(500 * time.Millisecond) return fmt.Errorf(\"mongodb_error_poison\") }) g.Go(func() error { req, _ := http.NewRequestWithContext(ctx, http.MethodGet, server.URL, nil) _, err := http.DefaultClient.Do(req) if err != nil { fmt.Printf(\"client.Do error: %v\\n\", err) } return err }) g.Wait() } The output will be:\nclient.Do error: Get \"http://127.0.0.1:41339\": mongodb_error_poison How come? What is going on? Any guesses?\nIt turns out the following is happening: errgroup.Wait() will cancel the context as soon as any of goroutines return an error. Internally, errgroup will use a special context.WithCancelCause() context which returns the context itself and a cancel function that accepts an error as a cause.\nNow, as soon as the context is cancelled, http.DefaultClient.Do(req) with a request that has our context immediately returns an error. But the method Do() has this comment: // Any returned error will be of type [*url.Error]. and the url.Error struct looks like this:\n// Error reports an error and the operation and URL that caused it. type Error struct { Op string URL string Err error } Long story short. The “cause” from the context, which is an error, will be assigned to the Err field in url.Error. This is how the database error bubbled up from the context and was returned from the HTTP call.\n","wordCount":"380","inLanguage":"en","datePublished":"2025-11-25T00:00:00Z","dateModified":"2025-11-25T00:00:00Z","mainEntityOfPage":{"@type":"WebPage","@id":"https://localhost:1313/posts/2025-11-25-my-bugs/"},"publisher":{"@type":"Organization","name":"Random notes to myself","logo":{"@type":"ImageObject","url":"https://localhost:1313/favicon.ico"}}}</script></head><body id=top><header class=header><nav class=nav><div class=logo><a href=https://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=https://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches></div></div><ul id=menu><li><a href=https://localhost:1313/archives/ title=archives><span>archives</span></a></li><li><a href=https://localhost:1313/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">My Bugs Graveyard</h1><div class=post-meta><span title='2025-11-25 00:00:00 +0000 UTC'>November 25, 2025</span>&nbsp;·&nbsp;2 min&nbsp;·&nbsp;380 words&nbsp;|&nbsp;<a href=https://github.com/slash3b/slash3b.github.io/content/posts/2025-11-25-my-bugs.markdown rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>This is a collection of subtle bugs I&rsquo;ve encountered in Go that took time to understand.
Each entry documents the issue, a reproducible example, and the root cause</p><h3 id=1-http-call-to-3rd-party-api-responds-with-error-from-our-local-database>1. HTTP call to 3rd party API responds with error from our local database<a hidden class=anchor aria-hidden=true href=#1-http-call-to-3rd-party-api-responds-with-error-from-our-local-database>#</a></h3><p>Diagnosis: I see a weird error in the logs, it looks like this:</p><pre tabindex=0><code>error happened GET https://example.com, &lt;service database error&gt;
</code></pre><p>where you can see endpoint URL and denoted with angle brackets an error from our own database. What the heck? How come we get an error from our own database when we call an endpoint?!</p><p>Below you will find a completely reproducible example:</p><div class=highlight><div style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><table style=border-spacing:0;padding:0;margin:0;border:0><tr><td style=vertical-align:top;padding:0;margin:0;border:0><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 1
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 2
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 3
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 4
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 5
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 6
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 7
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 8
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f"> 9
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">10
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">11
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">12
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">13
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">14
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">15
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">16
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">17
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">18
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">19
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">20
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">21
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">22
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">23
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">24
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">25
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">26
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">27
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">28
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">29
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">30
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">31
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">32
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">33
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">34
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">35
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">36
</span><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">37
</span></code></pre></td><td style=vertical-align:top;padding:0;margin:0;border:0;width:100%><pre tabindex=0 style=background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-golang data-lang=golang><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>package</span> main
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;text-decoration:underline>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;context&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;net/http&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;net/http/httptest&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;time&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#666;font-style:italic>&#34;golang.org/x/sync/errgroup&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=font-weight:700;font-style:italic;text-decoration:underline>func</span> <span style=color:#666;font-weight:700;font-style:italic>main</span>() {
</span></span><span style=display:flex><span>	server := httptest.<span style=color:#666;font-weight:700;font-style:italic>NewServer</span>(http.<span style=color:#666;font-weight:700;font-style:italic>HandlerFunc</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>(w http.ResponseWriter, r *http.Request) {
</span></span><span style=display:flex><span>		time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(2 * time.Second)
</span></span><span style=display:flex><span>		w.<span style=color:#666;font-weight:700;font-style:italic>WriteHeader</span>(http.StatusOK)
</span></span><span style=display:flex><span>	}))
</span></span><span style=display:flex><span>	<span style=font-weight:700;text-decoration:underline>defer</span> server.<span style=color:#666;font-weight:700;font-style:italic>Close</span>()
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g, ctx := errgroup.<span style=color:#666;font-weight:700;font-style:italic>WithContext</span>(context.<span style=color:#666;font-weight:700;font-style:italic>Background</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g.<span style=color:#666;font-weight:700;font-style:italic>Go</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>() <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>		time.<span style=color:#666;font-weight:700;font-style:italic>Sleep</span>(500 * time.Millisecond)
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> fmt.<span style=color:#666;font-weight:700;font-style:italic>Errorf</span>(<span style=color:#666;font-style:italic>&#34;mongodb_error_poison&#34;</span>)
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g.<span style=color:#666;font-weight:700;font-style:italic>Go</span>(<span style=font-weight:700;font-style:italic;text-decoration:underline>func</span>() <span style=font-weight:700;text-decoration:underline>error</span> {
</span></span><span style=display:flex><span>		req, _ := http.<span style=color:#666;font-weight:700;font-style:italic>NewRequestWithContext</span>(ctx, http.MethodGet, server.URL, <span style=font-weight:700;text-decoration:underline>nil</span>)
</span></span><span style=display:flex><span>		_, err := http.DefaultClient.<span style=color:#666;font-weight:700;font-style:italic>Do</span>(req)
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>if</span> err != <span style=font-weight:700;text-decoration:underline>nil</span> {
</span></span><span style=display:flex><span>			fmt.<span style=color:#666;font-weight:700;font-style:italic>Printf</span>(<span style=color:#666;font-style:italic>&#34;client.Do error: %v\n&#34;</span>, err)
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=font-weight:700;text-decoration:underline>return</span> err
</span></span><span style=display:flex><span>	})
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	g.<span style=color:#666;font-weight:700;font-style:italic>Wait</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></td></tr></table></div></div><p>The output will be:</p><pre tabindex=0><code>client.Do error: Get &#34;http://127.0.0.1:41339&#34;: mongodb_error_poison
</code></pre><p>How come? What is going on? Any guesses?</p><p>It turns out the following is happening:
<code>errgroup.Wait()</code> will cancel the context as soon as any of goroutines return an error.
Internally, <code>errgroup</code> will use a special <code>context.WithCancelCause()</code> context which returns the context itself
and a cancel function that <strong>accepts an error</strong> as a cause.</p><p>Now, as soon as the context is cancelled, <code>http.DefaultClient.Do(req)</code> with a request that has our context immediately returns an error.
But the method <code>Do()</code> has this comment:
<code>// Any returned error will be of type [*url.Error].</code>
and the <code>url.Error</code> struct looks like this:</p><pre tabindex=0><code>// Error reports an error and the operation and URL that caused it.
type Error struct {
        Op  string
        URL string
        Err error
}
</code></pre><p>Long story short. The &ldquo;cause&rdquo; from the context, which is an error, will be assigned to the <code>Err</code> field in <code>url.Error</code>.
This is how the database error bubbled up from the context and was returned from the HTTP call.</p></div><footer class=post-footer><ul class=post-tags></ul></footer></article></main><footer class=footer><span>&copy; 2025 <a href=https://localhost:1313/>Random notes to myself</a></span> ·
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>