<!doctype html><html lang=en dir=auto><head><script src="/livereload.js?mindelay=10&amp;v=2&amp;port=1313&amp;path=livereload" data-no-instant defer></script><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Case of a leaking timer in go | Random notes to myself</title>
<meta name=keywords content="memory leak,go,time.After"><meta name=description content='It was only an accident that I read a post on ArangoDB site and found the same leak in one of our projects at work. So this is going to be quite short, but nevertheless I want for have it in form of a blogpost.
Here is how leak looked like:
package main import ( "fmt" "runtime" "time" ) func main() { messags := make(chan string) for { select { case msg := <- messages: // do smth with msg fmt.'><meta name=author content><link rel=canonical href=http://localhost:1313/posts/2022-11-13-go-memory-leak-timer/><link crossorigin=anonymous href=/assets/css/stylesheet.bc1149f4a72aa4858d3a9f71462f75e5884ffe8073ea9d6d5761d5663d651e20.css integrity="sha256-vBFJ9KcqpIWNOp9xRi915YhP/oBz6p1tV2HVZj1lHiA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=http://localhost:1313/favicon.ico><link rel=icon type=image/png sizes=16x16 href=http://localhost:1313/favicon-16x16.png><link rel=icon type=image/png sizes=32x32 href=http://localhost:1313/favicon-32x32.png><link rel=apple-touch-icon href=http://localhost:1313/apple-touch-icon.png><link rel=mask-icon href=http://localhost:1313/safari-pinned-tab.svg><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=http://localhost:1313/posts/2022-11-13-go-memory-leak-timer/><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><meta property="og:title" content="Case of a leaking timer in go"><meta property="og:description" content='It was only an accident that I read a post on ArangoDB site and found the same leak in one of our projects at work. So this is going to be quite short, but nevertheless I want for have it in form of a blogpost.
Here is how leak looked like:
package main import ( "fmt" "runtime" "time" ) func main() { messags := make(chan string) for { select { case msg := <- messages: // do smth with msg fmt.'><meta property="og:type" content="article"><meta property="og:url" content="http://localhost:1313/posts/2022-11-13-go-memory-leak-timer/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-11-13T01:00:00+02:00"><meta property="article:modified_time" content="2022-11-13T01:00:00+02:00"><meta property="og:site_name" content="Random notes to myself"><meta name=twitter:card content="summary"><meta name=twitter:title content="Case of a leaking timer in go"><meta name=twitter:description content='It was only an accident that I read a post on ArangoDB site and found the same leak in one of our projects at work. So this is going to be quite short, but nevertheless I want for have it in form of a blogpost.
Here is how leak looked like:
package main import ( "fmt" "runtime" "time" ) func main() { messags := make(chan string) for { select { case msg := <- messages: // do smth with msg fmt.'><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"http://localhost:1313/posts/"},{"@type":"ListItem","position":2,"name":"Case of a leaking timer in go","item":"http://localhost:1313/posts/2022-11-13-go-memory-leak-timer/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Case of a leaking timer in go","name":"Case of a leaking timer in go","description":"It was only an accident that I read a post on ArangoDB site and found the same leak in one of our projects at work. So this is going to be quite short, but nevertheless I want for have it in form of a blogpost.\nHere is how leak looked like:\npackage main import ( \u0026#34;fmt\u0026#34; \u0026#34;runtime\u0026#34; \u0026#34;time\u0026#34; ) func main() { messags := make(chan string) for { select { case msg := \u0026lt;- messages: // do smth with msg fmt.","keywords":["memory leak","go","time.After"],"articleBody":"It was only an accident that I read a post on ArangoDB site and found the same leak in one of our projects at work. So this is going to be quite short, but nevertheless I want for have it in form of a blogpost.\nHere is how leak looked like:\npackage main import ( \"fmt\" \"runtime\" \"time\" ) func main() { messags := make(chan string) for { select { case msg := \u003c- messages: // do smth with msg fmt.Println(msg) return msg case \u003c-time.After(time.Second * 3): // do smth else fmt.Println(\"3 sec timer fired\") case \u003c-time.After(time.Second * 30): fmt.Println(\"30 sec timer fired\") return } } } What is wrong with it? There is a lot:\nLets remember what doc says about time.After package time // import \"time\" // After waits for the duration to elapse and then sends the current time // on the returned channel. // It is equivalent to NewTimer(d).C. // The underlying Timer is not recovered by the garbage collector // until the timer fires. If efficiency is a concern, use NewTimer // instead and call Timer.Stop if the timer is no longer needed. func After(d Duration) \u003c-chan Time { return NewTimer(d).C } That means that on first iteration we create 2 timers.\nNow, depending on the logic, here is what we have: note: a great catch here is that 30s times is always leaking. It never has a chance to fire! ever spinning loop,\nin case messages are not sent at all,\ntwo new timers created on each iteration with only 3s timer firing if anything is sent to messages channel then we quit, but leave 2 more timers hanging. A good question to ask is — how exactly timers are leaking? I imagine it this way, this loop exists in one stack frame. So once stack frame is removed, any data living on that stack is removed as well. Well, sometimes it is not that easy.\nStack allocation requires that the lifetime and memory footprint of a variable can be determined at compile time.\nAnd I am thinking, timer itself is an uncertain data type. Timer channel (it is a part of timer) can be used in many ways and be used concurrently by other variables, so we can not “just” delete it from stack! That is why timer escapes to heap.\nHow to fix? I’d go with context.WithDeadline() to be able to timeout loop and also I’d use time.Ticker instead of time.After. But I guess you can get creative with it as much as you like.\n","wordCount":"423","inLanguage":"en","datePublished":"2022-11-13T01:00:00+02:00","dateModified":"2022-11-13T01:00:00+02:00","mainEntityOfPage":{"@type":"WebPage","@id":"http://localhost:1313/posts/2022-11-13-go-memory-leak-timer/"},"publisher":{"@type":"Organization","name":"Random notes to myself","logo":{"@type":"ImageObject","url":"http://localhost:1313/favicon.ico"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=http://localhost:1313/ accesskey=h title="Home (Alt + H)"><img src=http://localhost:1313/apple-touch-icon.png alt aria-label=logo height=35>Home</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=http://localhost:1313/archives/ title=archives><span>archives</span></a></li><li><a href=http://localhost:1313/tags/ title=tags><span>tags</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class=post-title>Case of a leaking timer in go</h1><div class=post-meta>&lt;span title='2022-11-13 01:00:00 +0200 EET'>November 13, 2022&lt;/span>&amp;nbsp;·&amp;nbsp;2 min&amp;nbsp;·&amp;nbsp;423 words&nbsp;|&nbsp;<a href=https://github.com/slash3b/slash3b.github.io/content/posts/2022-11-13-go-memory-leak-timer.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=post-content><p>It was only an accident that I read a <a href=https://www.arangodb.com/2020/09/a-story-of-a-memory-leak-in-go-how-to-properly-use-time-after>post on ArangoDB site</a>
and found the same leak in one of our projects at work. So this is going to be quite short, but nevertheless I want for have
it in form of a blogpost.</p><p>Here is how leak looked like:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-golang data-lang=golang><span class=line><span class=cl><span class=kn>package</span> <span class=nx>main</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=p>(</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;fmt&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;runtime&#34;</span>
</span></span><span class=line><span class=cl>        <span class=s>&#34;time&#34;</span>
</span></span><span class=line><span class=cl><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>func</span> <span class=nf>main</span><span class=p>()</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>        <span class=nx>messags</span> <span class=o>:=</span> <span class=nb>make</span><span class=p>(</span><span class=kd>chan</span> <span class=kt>string</span><span class=p>)</span>
</span></span><span class=line><span class=cl>        <span class=k>for</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>select</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=nx>msg</span> <span class=o>:=</span> <span class=o>&lt;-</span> <span class=nx>messages</span><span class=p>:</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// do smth with msg
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=nx>msg</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span> <span class=nx>msg</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>3</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=c1>// do smth else
</span></span></span><span class=line><span class=cl><span class=c1></span>                        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;3 sec timer fired&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                <span class=k>case</span> <span class=o>&lt;-</span><span class=nx>time</span><span class=p>.</span><span class=nf>After</span><span class=p>(</span><span class=nx>time</span><span class=p>.</span><span class=nx>Second</span> <span class=o>*</span> <span class=mi>30</span><span class=p>):</span>
</span></span><span class=line><span class=cl>                        <span class=nx>fmt</span><span class=p>.</span><span class=nf>Println</span><span class=p>(</span><span class=s>&#34;30 sec timer fired&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>                        <span class=k>return</span>
</span></span><span class=line><span class=cl>                <span class=p>}</span>
</span></span><span class=line><span class=cl>        <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span></code></pre></div><h3 id=what-is-wrong-with-it>What is wrong with it?<a hidden class=anchor aria-hidden=true href=#what-is-wrong-with-it>#</a></h3><p>There is a lot:</p><h4 id=lets-remember-what-doc-says-about-timeafter>Lets remember what doc says about <code>time.After</code><a hidden class=anchor aria-hidden=true href=#lets-remember-what-doc-says-about-timeafter>#</a></h4><blockquote><pre tabindex=0><code>package time // import &#34;time&#34;

// After waits for the duration to elapse and then sends the current time
// on the returned channel.
// It is equivalent to NewTimer(d).C.
// The underlying Timer is not recovered by the garbage collector
// until the timer fires. If efficiency is a concern, use NewTimer
// instead and call Timer.Stop if the timer is no longer needed.
func After(d Duration) &lt;-chan Time {
      return NewTimer(d).C
}
</code></pre></blockquote><p>That means that on first iteration we create <strong>2 timers</strong>.</p><h4 id=now-depending-on-the-logic-here-is-what-we-have>Now, depending on the logic, here is what we have:<a hidden class=anchor aria-hidden=true href=#now-depending-on-the-logic-here-is-what-we-have>#</a></h4><ul><li>note: a great catch here is that 30s times is always leaking. It never has a chance to fire!</li><li>ever spinning loop,<br>in case <code>messages</code> are not sent at all,<br><em>two new timers created on each iteration</em> with only 3s timer firing</li><li>if anything is sent to <code>messages</code> channel then we quit, but leave 2 more timers hanging.</li></ul><p>A good question to ask is — how exactly timers are leaking? I imagine it this way, this loop exists in one stack frame.
So once stack frame is removed, any data living on that stack is removed as well.
Well, sometimes it is not that easy.</p><blockquote><p>Stack allocation requires that the lifetime and memory footprint of a variable can be determined at compile time.</p></blockquote><p>And I am thinking, timer itself is an uncertain data type. Timer channel (it is a part of timer) can be used in many ways and be used concurrently by
other variables, so we can not &ldquo;just&rdquo; delete it from stack! That is why timer escapes to heap.</p><h4 id=how-to-fix>How to fix?<a hidden class=anchor aria-hidden=true href=#how-to-fix>#</a></h4><p>I&rsquo;d go with <code>context.WithDeadline()</code> to be able to timeout loop and also I&rsquo;d use <code>time.Ticker</code> instead of <code>time.After</code>. But I guess you can get creative with it
as much as you like.</p></div><footer class=post-footer><ul class=post-tags><li><a href=http://localhost:1313/tags/memory-leak/>Memory Leak</a></li><li><a href=http://localhost:1313/tags/go/>Go</a></li><li><a href=http://localhost:1313/tags/time.after/>Time.After</a></li></ul><nav class=paginav><a class=prev href=http://localhost:1313/posts/2022-07-25-networking-notes/><span class=title>« Prev</span><br><span></span>
</a><a class=next href=http://localhost:1313/posts/2022-06-24-vim-notes/><span class=title>Next »</span><br><span>VIM cheat sheet</span></a></nav></footer></article></main><footer class=footer><span>&copy; 2024 <a href=http://localhost:1313/>Random notes to myself</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script></body></html>